name: Python CI Template (Org Standard - DEBUG)

on:
  workflow_call:
    inputs:
      python_versions:
        description: 'Comma-separated or JSON array. Example: 3.10,3.11,3.12 OR ["3.10","3.11"]'
        type: string
        default: "3.10,3.11,3.12"
      run_tests:
        type: boolean
        default: true
      enable_security:
        type: boolean
        default: true
      coverage_threshold:
        type: number
        default: 80
      debug:
        type: boolean
        default: true

permissions:
  contents: read
  security-events: write

jobs:
  # -------------------------
  # PREP (robust input -> JSON array)
  # -------------------------
  prep:
    runs-on: ubuntu-latest
    outputs:
      py_matrix: ${{ steps.set.outputs.py_matrix }}

    steps:
      - name: Setup Python (for prep)
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Debug - show raw input
        if: ${{ inputs.debug }}
        run: echo "Raw python_versions input - ${{ inputs.python_versions }}"

      - id: set
        name: Generate matrix JSON (safe)
        shell: bash
        env:
          VERS: ${{ inputs.python_versions }}
        run: |
          set -euo pipefail
          # Use Python to safely parse/normalize the versions input
          JSON=$(python3 -c "
          import os, json, sys
          s = os.environ.get('VERS', '').strip()
          if not s:
              sys.exit('python_versions input is empty')
          if s.startswith('[') and s.endswith(']'):
              s = s.replace(chr(39), chr(34))
              arr = json.loads(s)
          else:
              arr = [x.strip() for x in s.split(',') if x.strip()]
          if not isinstance(arr, list) or not arr:
              sys.exit('Invalid python_versions: ' + repr(s))
          print(json.dumps(arr))
          ")
          echo "py_matrix=$JSON" >> "$GITHUB_OUTPUT"
          echo "Generated py_matrix JSON: $JSON"

      - name: Debug - show computed output
        if: ${{ inputs.debug }}
        run: echo "prep output py_matrix = ${{ steps.set.outputs.py_matrix }}"


  # -------------------------
  # BUILD JOB (resilient + debug)
  # -------------------------
  build:
    name: Build (Python ${{ matrix.python }})
    needs: prep
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python: ${{ fromJson(needs.prep.outputs.py_matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Debug - repo files
        if: ${{ inputs.debug }}
        run: |
          echo "Repo root contents:"
          ls -la
          echo "Detected key files:"
          test -f requirements.txt && echo " - requirements.txt found" || echo " - requirements.txt NOT found"
          test -f pyproject.toml && echo " - pyproject.toml found" || echo " - pyproject.toml NOT found"
          test -f setup.py && echo " - setup.py found" || echo " - setup.py NOT found"
          test -d tests && echo " - tests/ folder found" || echo " - tests/ folder NOT found"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Debug - python and pip versions
        if: ${{ inputs.debug }}
        run: |
          python --version
          python -m pip --version

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ matrix.python }}-${{ hashFiles('requirements.txt', 'pyproject.toml', 'setup.py') }}

      - name: Install deps + build tools
        run: |
          set -e
          python -m pip install --upgrade pip
          pip install -U setuptools wheel build
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Create build artifact (package if possible, else source bundle)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist debug
          if [ -f pyproject.toml ] || [ -f setup.py ]; then
            echo "Packaging metadata found -> building wheel/sdist"
            python -m build 2>&1 | tee debug/build.log
          else
            echo "No packaging metadata -> creating source bundle"
            tar -czf dist/source.tar.gz . 2>&1 | tee debug/build.log
          fi
          echo "dist/ contents:" | tee -a debug/build.log
          ls -la dist | tee -a debug/build.log

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-build-${{ matrix.python }}
          path: dist/

      - name: Upload debug logs (build)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-debug-build-${{ matrix.python }}
          path: debug/


  # -------------------------
  # TEST JOB (separate + debug)
  # -------------------------
  test:
    name: Test (Python ${{ matrix.python }})
    if: ${{ inputs.run_tests }}
    needs: [prep, build]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python: ${{ fromJson(needs.prep.outputs.py_matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ matrix.python }}-${{ hashFiles('requirements.txt', 'pyproject.toml', 'setup.py') }}

      - name: Install test deps
        run: |
          set -e
          python -m pip install --upgrade pip
          pip install pytest coverage
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-build-${{ matrix.python }}
          path: dist/

      - name: Debug - show downloaded dist
        if: ${{ inputs.debug }}
        run: |
          echo "Downloaded dist contents:"
          ls -la dist || true

      - name: Run tests + coverage (safe test detection)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p reports debug
          HAS_TESTS="false"
          if [ -d tests ]; then
            HAS_TESTS="true"
          else
            if find . -maxdepth 2 -type f -name "*test*.py" | grep -q .; then
              HAS_TESTS="true"
            fi
          fi
          if [ "$HAS_TESTS" = "true" ]; then
            coverage run -m pytest 2>&1 | tee debug/test.log
            coverage xml -o reports/coverage.xml
            coverage report --fail-under=${{ inputs.coverage_threshold }}
          else
            echo "No tests found. Skipping pytest." | tee debug/test.log
            echo "<testsuite name='no-tests' tests='0' failures='0'/>" > reports/no-tests.xml
          fi

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-test-${{ matrix.python }}
          path: |
            reports/
            dist/

      - name: Upload debug logs (test)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-debug-test-${{ matrix.python }}
          path: debug/


  # -------------------------
  # SECURITY JOB (CodeQL)
  # -------------------------
  security:
    name: Security Scan (CodeQL)
    if: ${{ inputs.enable_security }}
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: CodeQL Init
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: CodeQL Analyze
        uses: github/codeql-action/analyze@v3


  # -------------------------
  # DEPLOYMENT GATE
  # -------------------------
  deploy-gate:
    name: Deployment Gate
    needs: [build, test, security]
    if: |
      always() &&
      needs.build.result == 'success' &&
      (inputs.run_tests == false || needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (inputs.enable_security == false || needs.security.result == 'success' || needs.security.result == 'skipped')
    runs-on: ubuntu-latest
    environment: production

    steps:
      - run: echo "Deployment approved (gate passed)"
