name: Python CI Template (Build + Test separated)

on:
  workflow_call:
    inputs:
      run_tests:
        type: boolean
        default: true
      enable_security:
        type: boolean
        default: true
      coverage_threshold:
        type: number
        default: 80

permissions:
  contents: read
  security-events: write

jobs:
  # -------------------------
  # BUILD JOB
  # -------------------------
  build:
    name: Build (Python ${{ matrix.python }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ matrix.python }}-${{ hashFiles('requirements.txt') }}

      - name: Install build tools + deps
        run: |
          python -m pip install --upgrade pip
          pip install build
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Build package (sdist + wheel)
        run: |
          python -m build
          ls -la dist

      - name: Upload build artifacts (packages)
        uses: actions/upload-artifact@v4
        with:
          name: python-dist-${{ matrix.python }}
          path: dist/


  # -------------------------
  # TEST JOB
  # -------------------------
  test:
    name: Test (Python ${{ matrix.python }})
    if: inputs.run_tests
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ matrix.python }}-${{ hashFiles('requirements.txt') }}

      - name: Install test deps
        run: |
          python -m pip install --upgrade pip
          pip install pytest coverage
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Download build artifacts (packages)
        uses: actions/download-artifact@v4
        with:
          name: python-dist-${{ matrix.python }}
          path: dist/

      - name: Run tests + coverage
        run: |
          mkdir -p reports
          coverage run -m pytest
          coverage xml -o reports/coverage.xml
          coverage report --fail-under=${{ inputs.coverage_threshold }}

      - name: Upload test artifacts (coverage + dist)
        uses: actions/upload-artifact@v4
        with:
          name: python-test-artifacts-${{ matrix.python }}
          path: |
            reports/
            dist/


  # -------------------------
  # SECURITY JOB (CodeQL)
  # -------------------------
  security:
    name: Security Scan (CodeQL)
    if: inputs.enable_security && inputs.run_tests
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: CodeQL Init
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: CodeQL Analyze
        uses: github/codeql-action/analyze@v3


  # -------------------------
  # DEPLOY GATE
  # -------------------------
  deploy-gate:
    name: Deployment Gate
    # If security is disabled, we only need test; if tests are disabled, we only need build.
    needs: [build, test, security]
    if: >
      always() &&
      needs.build.result == 'success' &&
      (
        inputs.run_tests == false ||
        needs.test.result == 'success'
      ) &&
      (
        inputs.enable_security == false ||
        needs.security.result == 'success' ||
        needs.security.result == 'skipped'
      )
    runs-on: ubuntu-latest
    environment: production

    steps:
      - run: echo "Deployment approved for Python pipeline"
