name: Python CI Template (Org Standard)

on:
  workflow_call:
    inputs:
      python_versions:
        description: "Comma-separated python versions, e.g. 3.10,3.11,3.12"
        type: string
        default: "3.10,3.11,3.12"
      run_tests:
        type: boolean
        default: true        # ...existing code...
        
        jobs:
          prep:
            name: prep
            runs-on: ubuntu-latest
            outputs:
              python-versions: ${{ steps.compute.outputs.python-versions }}
            steps:
              - name: Compute python matrix
                id: compute
                shell: bash
                run: |
                  # Accept input from workflow input/var; fall back to defaults
                  INPUT="${{ inputs.python_versions || vars.PYTHON_VERSIONS || '3.10,3.11,3.12' }}"
        
                  # If already an array, normalize quotes to double; else build JSON array
                  if [[ "$INPUT" =~ ^\[.*\]$ ]]; then
                    JSON="${INPUT//\'/\"}"
                  else
                    # Split on comma or space
                    IFS=', ' read -r -a arr <<< "$INPUT"
                    JSON="["
                    sep=""
                    for v in "${arr[@]}"; do
                      [[ -z "$v" ]] && continue
                      JSON="${JSON}${sep}\"$v\""
                      sep=","
                    done
                    JSON="${JSON}]"
                  fi
        
                  echo "python-versions=$JSON" >> "$GITHUB_OUTPUT"
        
          build:
            name: Build (Python ${{ matrix.python-version }})
            needs: prep
            runs-on: ubuntu-latest
            strategy:
              matrix:
                python-version: ${{ fromJson(needs.prep.outputs.python-versions) }}
            steps:
              # ...existing code...
        
          test:
            name: Test (Python ${{ matrix.python-version }})
            needs: prep
            runs-on: ubuntu-latest
            strategy:
              matrix:
                python-version: ${{ fromJson(needs.prep.outputs.python-versions) }}
            steps:
              # ...existing code...
        
          # If you have other jobs (e.g., CodeQL, Deployment Gate), keep them as-is
          # and ensure they depend on build/test as needed.
        # ...existing code...
      enable_security:
        type: boolean
        default: true
      coverage_threshold:
        type: number
        default: 80

permissions:
  contents: read
  security-events: write

jobs:
  # -------------------------
  # PREP (convert input string to JSON for matrix)
  # -------------------------
  prep:
    runs-on: ubuntu-latest
    outputs:
      py_matrix: ${{ steps.set.outputs.py_matrix }}
    steps:
      - id: set
        shell: bash
        run: |
          # Convert "3.10,3.11,3.12" -> ["3.10","3.11","3.12"]
          VERS="${{ inputs.python_versions }}"
          JSON=$(printf '%s' "$VERS" | awk -F',' 'BEGIN{print "["}{for(i=1;i<=NF;i++){gsub(/^[ \t]+|[ \t]+$/,"",$i); printf "\"%s\"%s",$i,(i<NF?",":"")} } END{print "]"}')
          echo "py_matrix=$JSON" >> "$GITHUB_OUTPUT"


  # -------------------------
  # BUILD JOB (resilient)
  # -------------------------
  build:
    name: Build (Python ${{ matrix.python }})
    needs: prep
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python: ${{ fromJson(needs.prep.outputs.py_matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ matrix.python }}-${{ hashFiles('requirements.txt', 'pyproject.toml', 'setup.py') }}

      - name: Install deps + build tools
        run: |
          python -m pip install --upgrade pip
          pip install -U setuptools wheel build
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Create build artifact (package if possible, else source bundle)
        shell: bash
        run: |
          set -e
          mkdir -p dist
          if [ -f pyproject.toml ] || [ -f setup.py ]; then
            echo "Packaging metadata found -> building wheel/sdist"
            python -m build
          else
            echo "No packaging metadata -> creating source bundle"
            tar -czf dist/source.tar.gz .
          fi
          ls -la dist

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-build-${{ matrix.python }}
          path: dist/


  # -------------------------
  # TEST JOB
  # -------------------------
  test:
    name: Test (Python ${{ matrix.python }})
    if: inputs.run_tests
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python: ${{ fromJson(needs.prep.outputs.py_matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ matrix.python }}-${{ hashFiles('requirements.txt', 'pyproject.toml', 'setup.py') }}

      - name: Install test deps
        run: |
          python -m pip install --upgrade pip
          pip install pytest coverage
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-build-${{ matrix.python }}
          path: dist/

      - name: Run tests + coverage (skip gracefully if no tests)
        shell: bash
        run: |
          mkdir -p reports
          if [ -d tests ] || ls -1 *test*.py >/dev/null 2>&1; then
            coverage run -m pytest
            coverage xml -o reports/coverage.xml
            coverage report --fail-under=${{ inputs.coverage_threshold }}
          else
            echo "No tests found. Skipping pytest."
            echo "<testsuite name='no-tests' tests='0' failures='0'/>" > reports/no-tests.xml
          fi

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-test-${{ matrix.python }}
          path: |
            reports/
            dist/


  # -------------------------
  # SECURITY JOB (CodeQL)
  # -------------------------
  security:
    name: Security Scan (CodeQL)
    if: inputs.enable_security
    needs: [build, test]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: CodeQL Init
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: CodeQL Analyze
        uses: github/codeql-action/analyze@v3


  # -------------------------
  # DEPLOYMENT GATE
  # -------------------------
  deploy-gate:
    name: Deployment Gate
    needs: [build, test, security]
    if: >
      always() &&
      needs.build.result == 'success' &&
      (
        inputs.run_tests == false ||
        needs.test.result == 'success' ||
        needs.test.result == 'skipped'
      ) &&
      (
        inputs.enable_security == false ||
        needs.security.result == 'success' ||
        needs.security.result == 'skipped'
      )
    runs-on: ubuntu-latest
    environment: production

    steps:
      - run: echo "Deployment approved (gate passed)"
