name: "ðŸš€ Enterprise CI Template"

# This workflow is intended to be called via `workflow_call` from other workflows
# or used as a reusable template inside an organization. It focuses on
# security/SCA scanning, unit testing, coverage collection, and SonarCloud
# analysis. All runners are pinned to `ubuntu-latest` to avoid expression
# evaluation pitfalls when callers pass empty strings.

on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version for setup"
        required: false
        type: string
        default: "20.x"
      run-snyk:
        description: "Enable Snyk scan"
        required: false
        type: boolean
        default: true
      run-sonar:
        description: "Enable SonarCloud analysis"
        required: false
        type: boolean
        default: true
    secrets:
      GITHUBTOKEN:
        required: true
      SONAR_TOKEN:
        required: false
      SNYK_TOKEN:
        required: false

defaults:
  run:
    shell: bash

concurrency:
  group: "enterprise-ci-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  compliance:
    name: "ðŸ›¡ï¸ Security & SCA"
    runs-on: ubuntu-latest
    if: ${{ inputs.run-snyk }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Run Snyk (SCA & vulnerabilities)
        # Pin to a specific release when you update this template
        uses: snyk/actions@v3
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  unit-tests:
    name: "ðŸ§ª Unit Tests"
    runs-on: ubuntu-latest
    needs: []
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests (headless)
        run: npm test -- --coverage --watchAll=false

      - name: Ensure coverage file exists (fallback)
        if: ${{ always() }}
        run: |
          if [ -f coverage/lcov.info ]; then
            echo "coverage file exists"
          else
            mkdir -p coverage
            echo "TN:" > coverage/lcov.info
            echo "SF:unknown" >> coverage/lcov.info
            echo "FNF:0" >> coverage/lcov.info
            echo "end_of_record" >> coverage/lcov.info
            echo "Created minimal coverage/lcov.info fallback"
          fi

      - name: Upload coverage artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/lcov.info

  sonarcloud:
    name: "ðŸ“Š SonarCloud Analysis"
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: ${{ inputs.run-sonar }}
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      - name: SonarCloud Scan
        # Pin this to a stable version string in your org
        uses: SonarSource/sonarcloud-github-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUBTOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.qualitygate.wait=true
